<?xml version="1.0" encoding="UTF-8"?>
<vuf>
  <action>
    function mountVehicle(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
    	var slot = vehicle.equipment.getSlots();
    	while(slot.hasNext()) {
    		var slot1 = slot.next();
        vehicle.equipment.get(slot1).removeEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),'changeEquip');});
    		vehicle.equipment.get(slot1).addEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),'changeEquip');});
    	}
      // updateVehicle(vehicle,false);
    }
</action><action>
    function dismountVehicle(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      trace('dismount');
      if (vehicle == null) return;
      var slot = vehicle.equipment.getSlots();
      while(slot.hasNext()) {
        var slot1 = slot.next();
        vehicle.equipment.get(slot1).removeEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),'changeEquip');});
      }
    }

</action><action>
    function updateVehicle(?v){
    var vehicle = v == null ? getLocalPlayer().vehicle : v;
    if (vehicle == null) return;
    // var window = null;
    // trace('updateVehicle');
      // try{throw
        updateHealth(vehicle);
        updateDefense(vehicle);
        updateSpeed(vehicle);
        updateWeight(vehicle);
        updateFuel(vehicle);
        updateHitDamage(vehicle);
        updateCloak(vehicle);
      // }catch(e:Dynamic){
      //   trace('Updaters '+e);
      // }
      // trace('Vehicle ' + player.vehicle + 'GUI ' + player.vehicle.gui);
      // trace(player.gui + player.getGUI());
      // try{throw
      vehicle.gui.init();
      // }catch(e:Dynamic){
      //   trace('GUI '+ e);
      // }

      // if (window == true){
      // evalXml('&lt;closeWindows modal="true"/>');
      // vehicle.manageEquipment();
      // }
    }
    // function setStat(stat, ?v){
    //   var vehicle = v == null ? getLocalPlayer().vehicle : v;
    //   if (vehicle == null) return;
    //   var info = vehicle.info;
    //   eval(info.'+stat+' = getStat(stat,vehicle));
    // }
</action><action>
    function getStat(stat, ?v){
      var vehicle = (v == null) ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      // trace('getStat ' + vehicle.info);
      var info = vehicle.info;
      if (info == null) return "WTF";
      var equipment = vehicle.equipment;
      var xml = info.xml;
      var stat1 = xml.get(stat);
      if (stat1 == null) stat1 = 0;
      var slot = equipment.getSlots();
		    while(slot.hasNext()) {
			      var slot1 = slot.next();
            if (equipment.get(slot1).value == null){ stat2 = null;}
            if (equipment.get(slot1).value != null){ stat2 = equipment.getItem(slot1).info.xml.get(stat);}
              if (stat2 != null){stat1 = Std.parseInt(stat1) + Std.parseInt(stat2);};
		    }
        trace("STAT1 : " + stat1);
        return stat1;
    }

</action><action>
    function updateHealth(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      trace('updateHealth ' + vehicle.info);
      vehicle.info.health = getStat('health',vehicle);
      if (vehicle.health > vehicle.info.health){vehicle.setHealth(vehicle.info.health);};
    }
</action><action>
    function updateDefense(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      var defense = getStat('defense',vehicle);
      info.front_defense = defense;
      info.back_defense = defense;
    }
</action><action>
    function updateSpeed(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.speedX = getStat('speed',vehicle);
      vehicle.info.speedY = getStat('speedY',vehicle) == null ? getStat('speed',vehicle) : getStat('speedY',vehicle);
    }

</action><action>
    function updateWeight(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.max_weight.set(getStat('max_weight',vehicle));
    }
</action><action>
    function updateFuel(?v){
      trace('updateFuel is not enabled yet');
    }
    </action><action>
    function updateRepair(?v){
      trace('updateRepair is not enabled yet');
    }
    </action><action>
    function updateRefuel(?v){
      trace('updateRefuel is not enabled yet');
    }
    </action><action>

    function updateHitDamage(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.hitDamage = getStat('hitDamage',vehicle);
    }
</action><action>
    function updateCloak(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var equipment = vehicle.equipment;
      var slot = equipment.getSlots();
      var hidden = vehicle.info.xml.get('hide');
		   while(slot.hasNext()) {
			  var slot1 = slot.next();
			  var hidden1 = equipment.getItem(slot1) == null ? null : equipment.getItem(slot1).info.xml.get('hide');
        if (hidden1 == 'true'){hidden = true;}
        if (hidden1 == 'false'){hidden = false;}
		   }
       // trace('Hidden ' + hidden);
      if (hidden == true){
        vehicle.setHidden(true);
        if (vehicle.renderer.alpha > 0.5) vehicle.renderer.lerp(new AlphaKeyframe(0.5),10);
      }else
      if (hidden == false){
        vehicle.setHidden(false);
        if (vehicle.renderer.alpha &lt;= 0.5) vehicle.renderer.lerp(new AlphaKeyframe(1),10);
      }else
      if (hidden == null){
        vehicle.setHidden(false);
        if (vehicle.renderer.alpha &lt;= 0.5) vehicle.renderer.lerp(new AlphaKeyframe(1),10);
      }
    }
  </action>
</vuf>
