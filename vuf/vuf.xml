<?xml version="1.0" encoding="UTF-8"?>
<vuf>
  <action>
    function mountVehicle(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
    	var slot = vehicle.equipment.getSlots();
    	while(slot.hasNext()) {
    		var slot1 = slot.next();
        vehicle.equipment.get(slot1).removeEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),'changeEquip');});
    		vehicle.equipment.get(slot1).addEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),'changeEquip');});
        vehicle.removeEventListener("update_fuel", storeFuel);
        vehicle.addEventListener("update_fuel", storeFuel);
    	}
      // updateVehicle(vehicle,false);
    }
</action><action>
    function dismountVehicle(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      trace('dismount');
      if (vehicle == null) return;
      var slot = vehicle.equipment.getSlots();
      while(slot.hasNext()) {
        var slot1 = slot.next();
        vehicle.equipment.get(slot1).removeEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),'changeEquip');});
        vehicle.removeEventListener("update_fuel", storeFuel);
      }
    }

</action><action>
    function updateVehicle(?v){
    var vehicle = v == null ? getLocalPlayer().vehicle : v;
    if (vehicle == null) return;
        updateHealth(vehicle);
        updateDefense(vehicle);
        updateMine(vehicle);
        updateSpeed(vehicle);
        updateWeight(vehicle);
        updateHitDamage(vehicle);
        updateCloak(vehicle);
        vehicle.gui.init();
    }
</action><action>
    function getStat(stat, ?v){
      var vehicle = (v == null) ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      // trace('getStat ' + vehicle.info);
      var info = vehicle.info;
      if (info == null) return "WTF";
      var equipment = vehicle.equipment;
      var xml = info.xml;
      var stat1 = xml.get(stat);
      if (stat1 == null) stat1 = 0;
      var slot = equipment.getSlots();
		    while(slot.hasNext()) {
			      var slot1 = slot.next();
            if (equipment.get(slot1).value == null){ stat2 = null;}
            if (equipment.get(slot1).value != null){ stat2 = equipment.getItem(slot1).info.xml.get(stat);}
              if (stat2 != null){stat1 = Std.parseInt(stat1) + Std.parseInt(stat2);};
		    }
        // trace("STAT1 : " + stat1);
        return stat1;
    }

</action><action>
    function updateHealth(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      // trace('updateHealth ' + vehicle.info);
      vehicle.info.health = getStat('health',vehicle);
      if (vehicle.health > vehicle.info.health){vehicle.setHealth(vehicle.info.health);};
    }
</action><action>
    function updateDefense(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      var defense = getStat('defense',vehicle);
      info.front_defense = defense;
      info.back_defense = defense;
    }
</action><action>
function updateMine(?v){
  var vehicle = v == null ? getLocalPlayer().vehicle : v;
  if (vehicle == null) return;
  var info = vehicle.info;
  vehicle.mine_power = getStat("mine");
  vehicle.mine_speed = getStat("mine_speed");
  vehicle.mine_fuel = getStat("mine_fuel");
}
</action><action>
    function updateSpeed(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.speedX = getStat('speed',vehicle);
      vehicle.info.speedY = getStat('speedY',vehicle) == (null || 0) ? getStat('speed',vehicle) : getStat('speedY',vehicle);
    }

</action><action>
    function updateWeight(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.max_weight.set(getStat('max_weight',vehicle));
    }
</action><action>
    function updateFuel(?v){
      var vehicle = (v == null) ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      var equipment = vehicle.equipment;
      var xml = info.xml;
      var max_fuel = null;
      var maxReplaceFuel = null;
      var slot = equipment.getSlots();
		    while(slot.hasNext()) {
			      var slot1 = slot.next();
            if (equipment.get(slot1).value == null){continue;}
            if (equipment.get(slot1).value != null){

		    }
        if (maxReplaceFuel == null){vehicle.info.fuel = Std.parseInt(max_fuel);}
    }
    </action><action>
    function updateRepair(?v){
      trace('updateRepair is not enabled yet');
    }
    </action><action>
    function updateRefuel(?v){
      trace('updateRefuel is not enabled yet');
    }
    </action><action>
    function setElectric(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
        vehicle.fuelName = "power";
        info.fuelItems = null;
        info.fuelMap = null;
        x = new Xml();
        x.nodeName = "fuelStorage";
        info.xml.second.xml.addChild(x);
        for (fXml in info.xml.elementsNamed('fuel')) {
            x.addChild(fXml);
        }
    }
    </action><action>
    function storeFuel(event) {
        var vehicle = event.target;
        var slot = vehicle.equipment.getSlots();
        while (slot.hasNext()){
            slot1 = slot.next();
            eItem = slot1.get();
            if (eItem != null && eItem.info.xml.elementsNamed('storeFuel').next() != null) {
                eItem.value = eItem.info.getDurability() - veh.fuel;
            }
        }
    }
    </action><action>
    function updateHitDamage(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.hitDamage = getStat('hitDamage',vehicle);
    }
</action><action>
    function updateCloak(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var equipment = vehicle.equipment;
      var slot = equipment.getSlots();
      var hidden = vehicle.info.xml.get('hide');
		   while(slot.hasNext()) {
			  var slot1 = slot.next();
			  var hidden1 = equipment.getItem(slot1) == null ? null : equipment.getItem(slot1).info.xml.get('hide');
        if (hidden1 == 'true'){hidden = true;}
        if (hidden1 == 'false'){hidden = false;}
		   }
      if (hidden == true){
        vehicle.setHidden(true);
        if (vehicle.renderer.alpha > 0.5) vehicle.renderer.lerp(new AlphaKeyframe(0.5),10);
      }else
      if (hidden == false){
        vehicle.setHidden(false);
        if (vehicle.renderer.alpha &lt;= 0.5) vehicle.renderer.lerp(new AlphaKeyframe(1),10);
      }else
      if (hidden == null){
        vehicle.setHidden(false);
        if (vehicle.renderer.alpha &lt;= 0.5) vehicle.renderer.lerp(new AlphaKeyframe(1),10);
      }
    }
  </action>
</vuf>
