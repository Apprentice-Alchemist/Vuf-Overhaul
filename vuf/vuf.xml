<?xml version="1.0" encoding="UTF-8"?>
<vuf>
  <action>
    function mountVehicle(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
    	var slot = vehicle.equipment.getSlots();
    	while(slot.hasNext()) {
    		var slot1 = slot.next();
        vehicle.equipment.get(slot1).removeEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),"changeEquip");});
    		vehicle.equipment.get(slot1).addEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),"changeEquip");});
        vehicle.removeEventListener("update_fuel", storeFuel);
        vehicle.addEventListener("update_fuel", storeFuel);
    	}
    }
</action><action>
    function dismountVehicle(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      trace("dismount");
      if (vehicle == null) return;
      var slot = vehicle.equipment.getSlots();
      while(slot.hasNext()) {
        var slot1 = slot.next();
        vehicle.equipment.get(slot1).removeEventListener("updated",function(e){vehicle.runEvent(getLocalPlayer(),"changeEquip");});
        vehicle.removeEventListener("update_fuel", storeFuel);
      }
    }

</action><action>
    function updateVehicle(?v){
    var vehicle = v == null ? getLocalPlayer().vehicle : v;
    if (vehicle == null) return;
        updateHealth(vehicle);
        updateDefense(vehicle);
        updateMine(vehicle);
        updateSpeed(vehicle);
        updateFuel(vehicle);
        updateWeight(vehicle);
        updateHitDamage(vehicle);
        updateCloak(vehicle);
        vehicle.gui.init();
    }
</action><action>
    function getStat(stat, ?v){
      var vehicle = (v == null) ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      if (info == null) return "WTF";
      var equipment = vehicle.equipment;
      var xml = info.xml;
      var stat1 = xml.get(stat);
      if (stat1 == null) stat1 = 0;
      var slot = equipment.getSlots();
		    while(slot.hasNext()) {
			      var slot1 = slot.next();
            if (equipment.get(slot1).value == null){stat2 = null;}
            if (equipment.get(slot1).value != null){stat2 = equipment.getItem(slot1).info.xml.get(stat);}
              if (stat2 != null){stat1 = Std.parseInt(stat1) + Std.parseInt(stat2);};
		    }
        return stat1;
    }

</action><action>
    function updateHealth(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.health = getStat("health",vehicle);
      if (vehicle.health > vehicle.info.health){vehicle.setHealth(vehicle.info.health);};
    }
</action><action>
    function updateDefense(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      var defense = getStat("defense",vehicle);
      info.front_defense = defense;
      info.back_defense = defense;
    }
</action><action>
    function updateMine(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      vehicle.mine_power = getStat("mine");
      vehicle.mine_speed = getStat("mine_speed");
      vehicle.mine_fuel = getStat("mine_fuel");
    }
</action><action>
    function updateSpeed(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.speedX = getStat("speed",vehicle);
      vehicle.info.speedY = getStat("speedY",vehicle) == (null || 0) ? getStat("speed",vehicle) : getStat("speedY",vehicle);
    }
</action><action>
    function updateWeight(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.info.max_weight.set(getStat("max_weight",vehicle));
    }
</action><action>
    function updateFuel(?v){
      var vehicle = (v == null) ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
      var equipment = vehicle.equipment;
      var xml = info.xml;
      var max_fuel = 0;
      var maxReplaceFuel = 0;
      var isElectric = null;
      var slot = equipment.getSlots();
		    while(slot.hasNext()) {
			      var slot1 = slot.next();
            if (equipment.get(slot1).value == null){ trace("update_fuel_continue"); continue;}
            if (equipment.get(slot1).value != null){
              var p = parseForFuel(slot1);
              if(p == null){continue;}
              if (p != null){
                trace(p);
                var temp_method = p[0];
                var temp_fuel = p[1];
                var temp_electric = p[2];
                var temp_fuel_change = p[3];
                isElectric = temp_electric;
                  if (temp_method == 'add'){
                    max_fuel = Std.parseInt(xml.get("fuel")) + Std.parseInt(temp_fuel);
                  } else if(temp_method == 'replace'){
                    maxReplaceFuel = Std.parseInt(temp_fuel);
                  }
                temp_fuelItems = [];
                temp_fuelMap = new StringMap();
                  for (o in temp_fuel_change){
                    tempFuelMap.set(o,temp_fuel_change.get(o));
                    temp_fuelItem.push(Recipe.createFuel(o,temp_fuel_change.get(o)));
                  }
                  if(temp_fuelMap.keys().hasNext()){
                    info.fuelItems = temp_fuelItems;
                    info.fuelMap = temp_fuelMap;
                  }
		           }
             }
           }
           try {throw
             if (maxReplaceFuel == 0){vehicle.info.fuel = Std.parseInt(max_fuel);}
             else {vehicle.info.fuel = Std.parseInt(maxReplaceFuel);};
           } catch (error:Dynamic) {
             if(error == 0){if (maxReplaceFuel == 0){vehicle.info.fuel = Std.parseInt(max_fuel);}
             else {vehicle.info.fuel = Std.parseInt(maxReplaceFuel);};} else {
             trace("Update Vehicle catch 1 : " + error);}
           }
           try{loadFuel(vehicle);
           }catch(error:Dynamic){
             trace(error);
           }
        try{if(isElectric){
          setElectric(vehicle);
        };}catch(e:Dynamic){trace(e);}
    </action><action>

    function parseForFuel(s){
      var item = s.get();
      if (s.get() == null){return;}
      trace(item);
      var fuel = item.info.xml.elementsNamed("fuel");
      trace(fuel);
      if (fuel == null || !fuel.hasNext()){return null;}
      if (fuel.hasNext()){
        trace("hasNext");
      fuel = fuel.next();
      var fuelChange = new StringMap();
      var fuelItem = new Array();
      try{
      for (o in fuel.elementsNamed("fuelChange")){
        trace(o);
        fuelChange.set(o.get("id"),Std.parseInt(o.get("value")));
        fuelItem.push(Recipe.createFuel(o.get("id"),Std.parseInt(o.get("value"))));
      };
    }catch(e:Dynamic){trace(e);}
      trace([fuel.get("method"),Std.parseInt(fuel.get("value")),fuel.get("electric"),fuelChange,fuelItem]);
      return [fuel.get("method"),Std.parseInt(fuel.get("value")),fuel.get("electric"),fuelChange,fuelItem];
    }
    }

    function loadFuel(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      var slot = vehicle.equipment.getSlots();
      while (slot.hasNext()){
          slot1 = slot.next();
          eItem = slot1.get();
          if (eItem != null && eItem.info.xml.elementsNamed("fuel").next() != null) {
              if (eItem.info.xml.elementsNamed("fuel").next().get("storeFuel") == "true"){
                veh.fuel = eItem.value;
                veh.info.fuel = eItem.getDurability();
              }
          }
      }
    }
    </action><action>

    function updateRepair(?v){
      trace("updateRepair is not enabled yet");
    }
    </action><action>

    // function updateRefuel(?v){
    //   trace("updateRefuel is not enabled yet");
    // }
    </action><action>

    function setElectric(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var info = vehicle.info;
        vehicle.fuelName = "power";
        info.fuelItems = null;
        info.fuelMap = null;
        x = new Xml();
        x.nodeName = "fuelStorage";
        info.xml.xml.addChild(x);
        for (fXml in info.xml.elementsNamed("fuel")) {
            x.addChild(fXml);
        }
    }
    </action><action>

    function storeFuel(event) {
        var veh = event.target;
        trace(veh);
        var slot = veh.equipment.getSlots();
        trace(slot);
        while (slot.hasNext()){
          slot1 = slot.next();
          trace(slot1);
          trace(slot1.get());
          eItem = slot1.get() == null ? null : slot1.get();
          trace(eItem);
          if (eItem == null){trace("Continue");continue; }
          if (eItem != null && eItem.info.xml.elementsNamed("fuel").next() != null) {
            trace("Hmmm");
              if (eItem.info.xml.elementsNamed("fuel").next().get("storeFuel") == "true"){
                eItem.value = veh.fuel;
              }
          }
        }
    }

    </action><action>

    function updateHitDamage(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      vehicle.hitDamage = getStat("hitDamage",vehicle);
    }

</action><action>

    function updateCloak(?v){
      var vehicle = v == null ? getLocalPlayer().vehicle : v;
      if (vehicle == null) return;
      var equipment = vehicle.equipment;
      var slot = equipment.getSlots();
      var hidden = vehicle.info.xml.get("hide");
		   while(slot.hasNext()) {
			  var slot1 = slot.next();
			  var hidden1 = equipment.getItem(slot1) == null ? null : equipment.getItem(slot1).info.xml.get("hide");
        if (hidden1 == "true"){hidden = true;}
        if (hidden1 == "false"){hidden = false;}
		   }
      if (hidden == true){
        vehicle.setHidden(true);
        if (vehicle.renderer.alpha > 0.5) vehicle.renderer.lerp(new AlphaKeyframe(0.5),10);
      }else
      if (hidden == false){
        vehicle.setHidden(false);
        if (vehicle.renderer.alpha &lt;= 0.5) vehicle.renderer.lerp(new AlphaKeyframe(1),10);
      }else
      if (hidden == null){
        vehicle.setHidden(false);
        if (vehicle.renderer.alpha &lt;= 0.5) vehicle.renderer.lerp(new AlphaKeyframe(1),10);
      }
    }

  </action>
</vuf>
